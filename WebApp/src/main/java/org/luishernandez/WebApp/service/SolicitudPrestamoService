package org.luishernandez.WebApp.service;

import org.luishernandez.WebApp.model.*;
import org.luishernandez.WebApp.repository.*;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;

@Service
public class SolicitudPrestamoService {

    private final SolicitudPrestamoRepository solicitudRepo;
    private final PrestamoRepository prestamoRepo;

    public SolicitudPrestamoService(
            SolicitudPrestamoRepository solicitudRepo,
            PrestamoRepository prestamoRepo
    ) {
        this.solicitudRepo = solicitudRepo;
        this.prestamoRepo = prestamoRepo;
    }

    public SolicitudPrestamo crearSolicitud(SolicitudPrestamo solicitud) {
        solicitud.setEstado(EstadoSolicitud.PENDIENTE);
        return solicitudRepo.save(solicitud);
    }

    public List<SolicitudPrestamo> listarPendientes() {
        return solicitudRepo.findByEstado(EstadoSolicitud.PENDIENTE);
    }

    @Transactional
    public Prestamo aprobarSolicitud(Long solicitudId) {

        SolicitudPrestamo solicitud = solicitudRepo.findById(solicitudId)
                .orElseThrow(() -> new RuntimeException("Solicitud no encontrada"));

        solicitud.setEstado(EstadoSolicitud.APROBADA);

        Prestamo prestamo = new Prestamo();
        prestamo.setCliente(solicitud.getCliente());
        prestamo.setMonto(solicitud.getMontoSolicitado());
        prestamo.setPlazoMeses(solicitud.getPlazoMeses());
        prestamo.setTasaInteres(solicitud.getTasaInteres());
        prestamo.setSolicitud(solicitud);

        solicitudRepo.save(solicitud);
        return prestamoRepo.save(prestamo);
    }

    public void rechazarSolicitud(Long solicitudId) {
        SolicitudPrestamo solicitud = solicitudRepo.findById(solicitudId)
                .orElseThrow(() -> new RuntimeException("Solicitud no encontrada"));

        solicitud.setEstado(EstadoSolicitud.RECHAZADA);
        solicitudRepo.save(solicitud);
    }
}